<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>utils_v2.db_handler &#8212; OsuArena 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=2709fde1"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for utils_v2.db_handler</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Every functionality that requires access to the database goes through this class.</span>
<span class="sd">Common class for both the website and the bot for database access</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">discord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">supabase</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncClient</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">utils_v2.enums.status</span><span class="w"> </span><span class="kn">import</span> <span class="n">FuncStatus</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils_v2.enums.tables</span><span class="w"> </span><span class="kn">import</span> <span class="n">TablesLeagues</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils_v2.log_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogHandler</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.enums</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">HistoricalPointsColumn</span><span class="p">,</span>
    <span class="n">MessageIdColumn</span><span class="p">,</span>
    <span class="n">RivalsColumn</span><span class="p">,</span>
    <span class="n">SeasonColumn</span><span class="p">,</span>
    <span class="n">SeasonStatus</span><span class="p">,</span>
    <span class="n">LeagueColumn</span><span class="p">,</span>
    <span class="n">TablesPoints</span><span class="p">,</span>
    <span class="n">TablesRivals</span><span class="p">,</span>
    <span class="n">ChallengeStatus</span><span class="p">,</span>
    <span class="n">TableMiscellaneous</span><span class="p">,</span>
    <span class="n">DiscordOsuColumn</span><span class="p">,</span>
    <span class="n">ChallengeFailed</span><span class="p">,</span>
    <span class="n">ChallengeUserColumn</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="DatabaseHandler">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DatabaseHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents an interface for interacting with the PostgreSQL database via Supabase.</span>

<span class="sd">    This class handles data retrieval and formatting for operations across</span>
<span class="sd">    both the Discord bot and the web dashboard.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    log_handler: :class:`LogHandler`</span>
<span class="sd">        The logger used for error handling and exception reporting.</span>
<span class="sd">        Typically, this should be an existing instance configured for</span>
<span class="sd">        either the bot or the web application.</span>
<span class="sd">    supabase_client: :class:`supabase.AsyncClient`</span>
<span class="sd">        The asynchronous client used to communicate with the Supabase API.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_handler</span><span class="p">:</span> <span class="n">LogHandler</span><span class="p">,</span> <span class="n">supabase_client</span><span class="p">:</span> <span class="n">AsyncClient</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span> <span class="o">=</span> <span class="n">log_handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span> <span class="o">=</span> <span class="n">supabase_client</span>

<div class="viewcode-block" id="DatabaseHandler.get_discord_id">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.get_discord_id">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_discord_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">osu_username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">discord_username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        A coroutine to access a user&#39;s discord_id through their osu/discord username.</span>
<span class="sd">        Give only one of the two arguments at a time</span>
<span class="sd">        Accesses table : discord_osu</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        osu_username : class:`str`</span>
<span class="sd">            user&#39;s osu username</span>

<span class="sd">        discord_username : class:`str`</span>
<span class="sd">        user&#39;s discord username</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        int | None</span>
<span class="sd">            The discord_id of the corresponding user if it exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># WARNING: Querying by discord_username is unreliable.</span>
        <span class="c1"># Users can change their Discord names, potentially</span>
        <span class="c1"># rendering database records stale. Always prefer</span>
        <span class="c1"># querying by osu_username or discord_id when possible.</span>
        <span class="n">log_context</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">discord_username</span><span class="p">:</span>
                <span class="n">log_context</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;discord_username: </span><span class="si">{</span><span class="n">discord_username</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">query</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_from_discord</span><span class="p">(</span><span class="n">discord_username</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_context</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;osu_username: </span><span class="si">{</span><span class="n">osu_username</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">query</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_from_osu</span><span class="p">(</span><span class="n">osu_username</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.get_discord_id()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Lookup failed for </span><span class="si">{</span><span class="n">log_context</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="DatabaseHandler.get_username">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.get_username">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        A coroutine to access a user&#39;s osu! username through their discord_id.</span>
<span class="sd">        Accesses table : discord_osu</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        discord_id : class:`int`</span>
<span class="sd">            The user&#39;s unique Discord ID.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        str | None</span>
<span class="sd">            The osu! username of the corresponding user if it exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: We return the osu_username, not the discord_username.</span>
        <span class="c1"># The discord_username stored in the database can be outdated</span>
        <span class="c1"># (stale) because users can change it (and it&#39;s not updated in the</span>
        <span class="c1"># database, after the intiial entry. The osu_username is the stable</span>
        <span class="c1"># identifier for this lookup as it&#39;s updated reguarly in database</span>
        <span class="c1"># (even better is discord_id which can&#39;t be changed).</span>
        <span class="c1"># But since Rivals Table doesn&#39;t have discord_id, this is the second</span>
        <span class="c1"># best choice</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_osu_from_id</span><span class="p">(</span><span class="n">discord_id</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">OSU_USERNAME</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.get_username()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Lookup failed for discord_id: </span><span class="si">{</span><span class="n">discord_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="DatabaseHandler.get_msg_id">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.get_msg_id">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_msg_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">challenge_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        A coroutine to access the message ID associated with a specific challenge.</span>
<span class="sd">        Accesses table : mesg_id</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        challenge_id : class:`int`</span>
<span class="sd">            The unique identifier of the challenge.</span>
<span class="sd">            Usually assigned when a new challenge is created in rivals table</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        int | None</span>
<span class="sd">            The message ID if it exists, otherwise ``None``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">MESG_ID</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">MessageIdColumn</span><span class="o">.</span><span class="n">MSG_ID</span><span class="p">)</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">MessageIdColumn</span><span class="o">.</span><span class="n">CHALLENGE_ID</span><span class="p">,</span> <span class="n">challenge_id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="n">row</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">MessageIdColumn</span><span class="o">.</span><span class="n">MSG_ID</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.get_msg_id()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to retrieve Msg ID for challenge </span><span class="si">{</span><span class="n">challenge_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="DatabaseHandler.top_play_detector">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.top_play_detector">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">top_play_detector</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Retrieves a list of users who have new top plays.</span>

<span class="sd">        This fetches the identification data (osu!/Discord IDs) for all users</span>
<span class="sd">        marked with ``top_play_announce = True`` in the database.</span>

<span class="sd">        The ``top_play_announce`` flag is set by the background worker in ``supabase.py``</span>
<span class="sd">        whenever a player achieves a new top play. This function detects those flags</span>
<span class="sd">        and retrieves the data for all such players.</span>

<span class="sd">        Accesses table : discord_osu</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        list[dict[str, Any]] | None</span>
<span class="sd">            A list of user records containing ID and username fields,</span>
<span class="sd">            or ``None`` if no users are found or an error occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># WARNING: It is strongly advised to access this data through</span>
        <span class="c1"># Monitor.monitor_top_plays() rather than calling this directly.</span>
        <span class="c1"># That method immediately resets &#39;top_play_announce&#39; to False after</span>
        <span class="c1"># retrieval, preventing race conditions and duplicate announcements.</span>
        <span class="n">query_selector</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">,</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">OSU_USERNAME</span><span class="p">,</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">OSU_ID</span><span class="p">,</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">TOP_PLAY_ID</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">DISCORD_OSU</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_selector</span><span class="p">))</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">TOP_PLAY_ANNOUNCE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.top_play_detector()&quot;</span><span class="p">,</span> <span class="n">error</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="DatabaseHandler.negate_top_play">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.negate_top_play">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">negate_top_play</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Resets the top play announcement flag for a user.</span>

<span class="sd">        This sets ``top_play_announce`` to ``False`` in the database, indicating</span>
<span class="sd">        that the pending top play has been successfully processed and announced.</span>

<span class="sd">        Accesses table : discord_osu</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        discord_id : class:`int`</span>
<span class="sd">            The user&#39;s unique Discord ID.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        bool</span>
<span class="sd">            ``True`` if the update was successful, ``False`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">DISCORD_OSU</span><span class="p">)</span>
                <span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">TOP_PLAY_ANNOUNCE</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.negate_top_play()&quot;</span><span class="p">,</span>
                <span class="n">e</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to negate top play for &lt;@</span><span class="si">{</span><span class="n">discord_id</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="DatabaseHandler.new_player_detector">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.new_player_detector">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">new_player_detector</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Retrieves a list of newly registered users waiting for an announcement.</span>

<span class="sd">        This fetches identification and league data for all users marked with</span>
<span class="sd">        ``new_player_announce = True`` in the database.</span>

<span class="sd">        The ``new_player_announce`` flag is set by the background worker in ``supabase.py``</span>
<span class="sd">        whenever a new player /links their account. This function detects those flags</span>
<span class="sd">        and retrieves the data for all such players.</span>

<span class="sd">        Accesses table : discord_osu</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        list[dict[str, Any]] | None</span>
<span class="sd">            A list of user records containing ID, username, and league fields,</span>
<span class="sd">            or ``None`` if no users are found or an error occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># WARNING: It is strongly advised to access this data through</span>
        <span class="c1"># Monitor.monitor_new_players() rather than calling this directly.</span>
        <span class="c1"># That method immediately resets &#39;new_player_announce&#39; to False after</span>
        <span class="c1"># retrieval, preventing race conditions and duplicate announcements.</span>
        <span class="n">query_selector</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">,</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">LEAGUE</span><span class="p">,</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">OSU_ID</span><span class="p">,</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">OSU_USERNAME</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">DISCORD_OSU</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_selector</span><span class="p">))</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">NEW_PLAYER_ANNOUNCE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.new_player_detector()&quot;</span><span class="p">,</span> <span class="n">error</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="DatabaseHandler.negate_new_player_announce">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.negate_new_player_announce">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">negate_new_player_announce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Resets the new player announcement flag for a user.</span>

<span class="sd">        This sets ``new_player_announce`` to ``False`` in the database, indicating</span>
<span class="sd">        that the new player arrival has been successfully processed and announced.</span>

<span class="sd">        Accesses table : discord_osu</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        discord_id : class:`int`</span>
<span class="sd">            The user&#39;s unique Discord ID.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        bool</span>
<span class="sd">            ``True`` if the update was successful, ``False`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">DISCORD_OSU</span><span class="p">)</span>
                <span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">NEW_PLAYER_ANNOUNCE</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.negate_new_player_announce()&quot;</span><span class="p">,</span>
                <span class="n">e</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to negate new player for &lt;@</span><span class="si">{</span><span class="n">discord_id</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="DatabaseHandler.get_current_league_table">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.get_current_league_table">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_league_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">league</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Retrieves the current standings for a specific league.</span>

<span class="sd">        This method first triggers a remote procedure call (``sync_table_pp``)</span>
<span class="sd">        to ensure all player performance points are up-to-date, and then</span>
<span class="sd">        fetches the sorted league data.</span>

<span class="sd">        Accesses table : f&quot;{TablesLeagues.(any)}&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        league : class:`str`</span>
<span class="sd">            The name of the league table to retrieve (e.g., &quot;silver&quot;, &quot;gold&quot;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        tuple[list[str], list[tuple[Any]]]</span>
<span class="sd">            A tuple containing:</span>
<span class="sd">            1. A list of column headers (strings).</span>
<span class="sd">            2. A list of rows, where each row is a tuple of values.</span>
<span class="sd">            Returns ``([], [])`` if the synchronization or fetch fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">rpc</span><span class="p">(</span>
                <span class="s2">&quot;sync_table_pp&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;tbl_name&quot;</span><span class="p">:</span> <span class="n">league</span><span class="p">}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;get_current_league_table(</span><span class="si">{</span><span class="n">league</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="s2">&quot;Failed to sync PP values.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_league_data</span><span class="p">(</span><span class="n">league</span><span class="p">)</span></div>


<div class="viewcode-block" id="DatabaseHandler.get_archived_league_table">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.get_archived_league_table">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_archived_league_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">league</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">season</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Retrieves historical standings for a specific past season.</span>

<span class="sd">        This constructs the archived table name (e.g., &quot;silver_1&quot;) and fetches</span>
<span class="sd">        the data.</span>

<span class="sd">        Accesses table : f&quot;{ArchivedTable.(any)}&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        league : class:`str`</span>
<span class="sd">            The name of the league (e.g., &quot;silver&quot;).</span>
<span class="sd">        season : class:`int`</span>
<span class="sd">            The season number to retrieve.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        tuple[list[str], list[tuple[Any]]]</span>
<span class="sd">            A tuple containing headers and row data for the archived season.</span>
<span class="sd">            Returns ``([], [])`` if the table does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">league</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_league_data</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="DatabaseHandler.get_rivals_table">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.get_rivals_table">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_rivals_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Retrieves the rivals table filtered by challenge status.</span>

<span class="sd">        This method first triggers a remote procedure call (``sync_rivals``)</span>
<span class="sd">        to ensure match statistics are up-to-date. The columns returned vary</span>
<span class="sd">        depending on whether the status is &#39;Unfinished&#39; or &#39;Finished&#39;.</span>

<span class="sd">        When passing the status it&#39;s recommended you pass it as an attribute of</span>
<span class="sd">        ChallengeStatus class.</span>

<span class="sd">        Accesses table : rivals</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        status : class:`str`</span>
<span class="sd">            The status to filter by (e.g., ``ChallengeStatus.UNFINISHED``).</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        tuple[list[str], list[tuple[Any]]]</span>
<span class="sd">            A tuple containing headers and formatted row data.</span>
<span class="sd">            Returns ``([], [])`` on failure or if no data is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">rpc</span><span class="p">(</span><span class="s2">&quot;sync_rivals&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.get_rivals_table()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="s2">&quot;Failed running postgres function : sync_rivals()&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">ChallengeStatus</span><span class="o">.</span><span class="n">UNFINISHED</span><span class="p">:</span>
            <span class="n">query_selector</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGER</span><span class="p">,</span>
                <span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGED</span><span class="p">,</span>
                <span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGER_STATS</span><span class="p">,</span>
                <span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGED_STATS</span><span class="p">,</span>
                <span class="n">RivalsColumn</span><span class="o">.</span><span class="n">FOR_PP</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query_selector</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGER</span><span class="p">,</span>
                <span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGED</span><span class="p">,</span>
                <span class="n">RivalsColumn</span><span class="o">.</span><span class="n">WINNER</span><span class="p">,</span>
                <span class="n">RivalsColumn</span><span class="o">.</span><span class="n">FOR_PP</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TablesRivals</span><span class="o">.</span><span class="n">RIVALS</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_selector</span><span class="p">))</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGE_STATUS</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arrange_table</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.get_rivals_table()&quot;</span><span class="p">,</span> <span class="n">error</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="DatabaseHandler.add_points">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.add_points">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">add_points</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">osu_uname</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Adds points to a user&#39;s account via a database RPC function (`add_points`)</span>

<span class="sd">        You must provide either a ``discord_id`` (which will be resolved to a username)</span>
<span class="sd">        or the ``osu_username`` directly. Exactly one parameter required at a time.</span>

<span class="sd">        Accesses table : discord_osu</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        points : class:`int`</span>
<span class="sd">            The amount of points to add.</span>
<span class="sd">        discord_id : class:`int` | None</span>
<span class="sd">            The user&#39;s Discord ID.</span>
<span class="sd">        osu_username : class:`str` | None</span>
<span class="sd">            The user&#39;s osu! username.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        dict[str, Any] | bool</span>
<span class="sd">            The updated row data (as a dict) if successful, or ``False`` on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Update the &#39;add_points&#39; PostgreSQL RPC to accept &#39;discord_id&#39; directly.</span>
        <span class="c1"># While &#39;osu_username&#39; is synchronized regularly, &#39;discord_id&#39; is immutable</span>
        <span class="c1"># and provides a more robust identifier. This would also remove the need</span>
        <span class="c1"># for the intermediate username lookup in this function.</span>
        <span class="k">if</span> <span class="n">discord_id</span><span class="p">:</span>
            <span class="n">osu_uname</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_username</span><span class="p">(</span><span class="n">discord_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">rpc</span><span class="p">(</span>
                    <span class="s2">&quot;add_points&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;player&quot;</span><span class="p">:</span> <span class="n">osu_uname</span><span class="p">,</span> <span class="s2">&quot;given_points&quot;</span><span class="p">:</span> <span class="n">points</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">single</span><span class="p">()</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;RPC add_points returned empty data&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.add_points()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Error adding </span><span class="si">{</span><span class="n">points</span><span class="si">}</span><span class="s2"> points for &lt;@</span><span class="si">{</span><span class="n">discord_id</span><span class="si">}</span><span class="s2">&gt;.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="DatabaseHandler.get_current_points">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.get_current_points">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_points</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">point_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Retrieves the top 15 players for (Univseral/ Seasonal) point category.</span>

<span class="sd">        This queries the discord_osu table to fetch rankings based on the</span>
<span class="sd">        given points-type column.</span>

<span class="sd">        Accesses table : discord_osu</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        point_type : class:`str`</span>
<span class="sd">            The database column name of the point type to retrieve.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        tuple[list[str], list[tuple[Any]]]</span>
<span class="sd">            A tuple containing headers and the top 15 rows of data.</span>
<span class="sd">            Returns ``([], [])`` if no data is found or on error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query_selector</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">OSU_USERNAME</span><span class="p">,</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">CURRENT_PP</span><span class="p">,</span>
            <span class="n">point_type</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">DISCORD_OSU</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_selector</span><span class="p">))</span>
                <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
                <span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">point_type</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arrange_table</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.get_current_points()&quot;</span><span class="p">,</span> <span class="n">e</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="DatabaseHandler.get_archived_points">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.get_archived_points">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_archived_points</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">season</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Retrieves the data for top 15 point scorers for a specific past season.</span>

<span class="sd">        This queries the historical points table, selecting the column</span>
<span class="sd">        corresponding to the requested season (e.g., ``season_3``) and aliasing</span>
<span class="sd">        it to ``points`` for formatting purposes.</span>


<span class="sd">        Accesses table : historical_points</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        season : class:`int`</span>
<span class="sd">            The season number to retrieve data for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        tuple[list[str], list[tuple[Any]]]</span>
<span class="sd">            A tuple containing headers and the top 15 rows of data.</span>
<span class="sd">            Returns ``([], [])`` if the season data is missing or an error occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">col_alias</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;points:season_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TablesPoints</span><span class="o">.</span><span class="n">HISTORICAL_POINTS</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">HistoricalPointsColumn</span><span class="o">.</span><span class="n">OSU_USERNAME</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">col_alias</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
                <span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;season_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arrange_table</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.get_archived_points()&quot;</span><span class="p">,</span> <span class="n">error</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="DatabaseHandler.get_archived_season">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.get_archived_season">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_archived_season</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Retrieves a list of all season numbers that are currently archived.</span>

<span class="sd">        Accesses table : seasons</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        list[int]</span>
<span class="sd">            A list of season integers (e.g., ``[1, 2, 3]``).</span>
<span class="sd">            Returns an empty list (``[]``) if no archived seasons are found or and error occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">SEASONS</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">SeasonColumn</span><span class="o">.</span><span class="n">SEASON</span><span class="p">)</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">SeasonColumn</span><span class="o">.</span><span class="n">STATUS</span><span class="p">,</span> <span class="n">SeasonStatus</span><span class="o">.</span><span class="n">ARCHIVED</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">SeasonColumn</span><span class="o">.</span><span class="n">SEASON</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.get_archived_season()&quot;</span><span class="p">,</span> <span class="n">error</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="DatabaseHandler.get_active_challenge_count">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.get_active_challenge_count">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_active_challenge_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Calculates the total number of active challenges for a specific user.</span>

<span class="sd">        This checks both the &#39;challenger&#39; and &#39;challenged&#39; columns to count</span>
<span class="sd">        how many Unfinished/ Pending challenges the user is currently involved in.</span>

<span class="sd">        Accesses tables = f&quot;{TablesRivals.(any)}&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        discord_id : class:`int`</span>
<span class="sd">            The user&#39;s unique Discord ID.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        int | None</span>
<span class="sd">            The total count of active challenges.</span>
<span class="sd">            Returns ``None`` if a database lookup fails 0 if not challenge for the player exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">challenger_instances</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_in_challenge_tble</span><span class="p">(</span>
            <span class="n">discord_id</span><span class="p">,</span> <span class="n">TablesRivals</span><span class="o">.</span><span class="n">CHALLENGER</span>
        <span class="p">)</span>
        <span class="n">challenged_instances</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_in_challenge_tble</span><span class="p">(</span>
            <span class="n">discord_id</span><span class="p">,</span> <span class="n">TablesRivals</span><span class="o">.</span><span class="n">CHALLENGED</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">challenged_instances</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">challenger_instances</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">challenger_instances</span> <span class="o">+</span> <span class="n">challenged_instances</span></div>


<div class="viewcode-block" id="DatabaseHandler.validate_shared_league">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.validate_shared_league">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validate_shared_league</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">league</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Checks if a user belongs to a specific league.</span>

<span class="sd">        This performs a lightweight &quot;head&quot; query (counting rows without fetching data)</span>
<span class="sd">        to verify if the user exists in the specified league.</span>

<span class="sd">        Accesses table : discord_osu</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        discord_id : class:`int`</span>
<span class="sd">            The user&#39;s unique Discord ID.</span>
<span class="sd">        league : class:`str`</span>
<span class="sd">            The name of the league to check (e.g., &quot;gold&quot;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        bool</span>
<span class="sd">            ``True`` if the user is in the specified league, ``False`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">league</span> <span class="o">=</span> <span class="n">league</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">DISCORD_OSU</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">LEAGUE</span><span class="p">,</span> <span class="n">league</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="c1"># if response.count == 0, it still means false and we return false</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.validate_shared_league()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Error for &lt;@</span><span class="si">{</span><span class="n">discord_id</span><span class="si">}</span><span class="s2">&gt; checking </span><span class="si">{</span><span class="n">league</span><span class="si">}</span><span class="s2"> League&quot;</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="DatabaseHandler.check_challenge_eligibility">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.check_challenge_eligibility">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_challenge_eligibility</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">challenger_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">challenged_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChallengeFailed</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Determines if a user is eligible to challenge another user based on their challenge history.</span>

<span class="sd">        This function acts as an orchestrator. It resolves Discord IDs to osu!</span>
<span class="sd">        usernames, fetches the match history between the two players, and passes</span>
<span class="sd">        that data to the rule validator.</span>

<span class="sd">        **Rule Checks:**</span>
<span class="sd">        1. Checks for any challenges between the pair within the last 24 hours.</span>
<span class="sd">        2. Checks for any currently unfinished or pending challenges.</span>

<span class="sd">        Internal calls: :meth:`get_username`, :meth:`_fetch_rivals_history`</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        challenger_id : :class:`int`</span>
<span class="sd">            The Discord ID of the user initiating the challenge.</span>
<span class="sd">        challenged_id : :class:`int`</span>
<span class="sd">            The Discord ID of the user receiving the challenge.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`ChallengeFailed`</span>
<span class="sd">            The status of the eligibility check:</span>

<span class="sd">            * ``ChallengeFailed.GOOD``: The users are eligible to challenge.</span>
<span class="sd">            * ``ChallengeFailed.PENDING``: A pending challenge already exists between the two.</span>
<span class="sd">            * ``ChallengeFailed.ONGOING``: An unfinished challenge exists between the two.</span>
<span class="sd">            * ``ChallengeFailed.TOO_EARLY``: A challenge (of any status) occurred within the last 24 hours.</span>
<span class="sd">            * ``ChallengeFailed.BAD_LINK``: One or both users are not linked to the system.</span>
<span class="sd">            * ``ChallengeFailed.FAILED``: An internal database error prevented the check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">challenger_uname</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_username</span><span class="p">(</span><span class="n">challenger_id</span><span class="p">)</span>
        <span class="n">challenged_uname</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_username</span><span class="p">(</span><span class="n">challenged_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">challenger_uname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">challenged_uname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ChallengeFailed</span><span class="o">.</span><span class="n">BAD_LINK</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_rivals_history</span><span class="p">(</span>
                <span class="n">challenger_uname</span><span class="p">,</span> <span class="n">challenged_uname</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_challenge_rules</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.check_challenge_eligibility()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Error checking eligibility: </span><span class="si">{</span><span class="n">challenger_id</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">challenged_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">ChallengeFailed</span><span class="o">.</span><span class="n">FAILED</span></div>


<div class="viewcode-block" id="DatabaseHandler.log_rivals">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.log_rivals">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">log_rivals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">challenger</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">Member</span><span class="p">,</span>
        <span class="n">challenged</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">Member</span><span class="p">,</span>
        <span class="n">for_pp</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">league</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Initiates and logs a new challenge match between two users.</span>

<span class="sd">        This method performs a two-step logging process:</span>

<span class="sd">        1. Calls the Supabase RPC ``log_rivals`` to create the primary match record in rivals table.</span>
<span class="sd">        2. Calls :meth:`_log_to_challenge_tables` to populate the auxillary tables challenged and challenger</span>

<span class="sd">        Internal calls: :meth:`get_username`, :meth:`_log_to_challenge_tables`</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        challenger : :class:`discord.Member`</span>
<span class="sd">            The Discord member object of the user initiating the challenge.</span>
<span class="sd">        challenged : :class:`discord.Member`</span>
<span class="sd">            The Discord member object of the user receiving the challenge.</span>
<span class="sd">        for_pp : :class:`int`</span>
<span class="sd">            The amount of points (PP) effectively wagered on this match.</span>
<span class="sd">        league : :class:`str`</span>
<span class="sd">            The identifier of the league this match belongs to (e.g., &quot;gold&quot;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`dict` | None</span>
<span class="sd">            The data returned by the database RPC if successful (usually containing the new Match ID).</span>
<span class="sd">            Returns ``None`` if an error occurs during the logging process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">challenger_uname</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_username</span><span class="p">(</span><span class="n">challenger</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">challenged_uname</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_username</span><span class="p">(</span><span class="n">challenged</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">rpc</span><span class="p">(</span>
                <span class="s2">&quot;log_rivals&quot;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;challenger_uname&quot;</span><span class="p">:</span> <span class="n">challenger_uname</span><span class="p">,</span>
                    <span class="s2">&quot;challenged_uname&quot;</span><span class="p">:</span> <span class="n">challenged_uname</span><span class="p">,</span>
                    <span class="s2">&quot;for_pp&quot;</span><span class="p">:</span> <span class="n">for_pp</span><span class="p">,</span>
                    <span class="s2">&quot;league&quot;</span><span class="p">:</span> <span class="n">league</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error logging challenge: &lt;@</span><span class="si">{</span><span class="n">challenger</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&gt; vs &lt;@</span><span class="si">{</span><span class="n">challenged</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&gt;.&quot;</span>
                <span class="p">)</span>

            <span class="n">response2</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_to_challenge_tables</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">challenger</span><span class="p">,</span>
                <span class="n">challenged</span><span class="p">,</span>
                <span class="n">challenger_uname</span><span class="p">,</span>
                <span class="n">challenged_uname</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">response2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error logging challenge details: &lt;@</span><span class="si">{</span><span class="n">challenger</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&gt; vs &lt;@</span><span class="si">{</span><span class="n">challenged</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&gt;.&quot;</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.log_rivals()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Error logging challenge: &lt;@</span><span class="si">{</span><span class="n">challenger</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&gt; vs &lt;@</span><span class="si">{</span><span class="n">challenged</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&gt;.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="DatabaseHandler.accept_challenge">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.accept_challenge">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">accept_challenge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">challange_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Marks a specific challenge as accepted(Pending -&gt; Unfinishd) in the rivals table.</span>

<span class="sd">        This calls the Supabase RPC ``accept_challenge``, which updates the match status</span>
<span class="sd">        as well as logs in the accepted date (now) and current pp as &#39;initial_pp&#39;.</span>
<span class="sd">        It returns discord_id of the two rivals players as well as the number of pp they</span>
<span class="sd">        playing for, this will be used to later make announcement in the public discord</span>
<span class="sd">        channel.</span>


<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        challenge_id : :class:`int`</span>
<span class="sd">            The unique ID of the challenge to accept.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`list`[:class:`int`] | None</span>
<span class="sd">            A list containing ``[challenger_id, challenged_id, for_pp]`` if successful.</span>
<span class="sd">            Returns ``None`` if the challenge ID was not found or an error occurred.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">rpc</span><span class="p">(</span>
                <span class="s2">&quot;accept_challenge&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;p_challenge_id&quot;</span><span class="p">:</span> <span class="n">challange_id</span><span class="p">}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">match_data</span> <span class="o">=</span> <span class="n">data</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">challenger_id</span> <span class="o">=</span> <span class="n">match_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;out_challenger_id&quot;</span><span class="p">)</span>
                <span class="n">challenged_id</span> <span class="o">=</span> <span class="n">match_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;out_challenged_id&quot;</span><span class="p">)</span>
                <span class="n">for_pp</span> <span class="o">=</span> <span class="n">match_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;out_for_pp&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find challenge with id : </span><span class="si">{</span><span class="n">challange_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">challenger_id</span><span class="p">,</span> <span class="n">challenged_id</span><span class="p">,</span> <span class="n">for_pp</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.accept_challenge()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to accept challenge, challenge_id : </span><span class="si">{</span><span class="n">challange_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="DatabaseHandler.decline_challenge">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.decline_challenge">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">decline_challenge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">challange_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Marks a specific challenge as declined (Pending -&gt; Declined) in the rivals table.</span>

<span class="sd">        This calls the Supabase RPC ``decline_challenge``, which updates the match status</span>
<span class="sd">        to mark it as declined. Also updates the &#39;ended_at&#39; column of rivals tables to log in</span>
<span class="sd">        the time right now. It returns the discord_id of the two rival players which will be</span>
<span class="sd">        used to notify in the public channel that this challenge was declined</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        challenge_id : :class:`int`</span>
<span class="sd">            The unique ID of the challenge to decline.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`list`[:class:`int`] | None</span>
<span class="sd">            A list containing ``[challenger_id, challenged_id, for_pp]`` if successful.</span>
<span class="sd">            Returns ``None`` if the challenge ID was not found or an error occurred.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">rpc</span><span class="p">(</span>
                <span class="s2">&quot;decline_challenge&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;p_challenge_id&quot;</span><span class="p">:</span> <span class="n">challange_id</span><span class="p">}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">match_data</span> <span class="o">=</span> <span class="n">data</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">challenger_id</span> <span class="o">=</span> <span class="n">match_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;out_challenger_id&quot;</span><span class="p">)</span>
                <span class="n">challenged_id</span> <span class="o">=</span> <span class="n">match_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;out_challenged_id&quot;</span><span class="p">)</span>
                <span class="n">for_pp</span> <span class="o">=</span> <span class="n">match_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;out_for_pp&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find challenge with id : </span><span class="si">{</span><span class="n">challange_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">challenger_id</span><span class="p">,</span> <span class="n">challenged_id</span><span class="p">,</span> <span class="n">for_pp</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.decline_challenge()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to decline challenge, challenge_id : </span><span class="si">{</span><span class="n">challange_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="DatabaseHandler.revoke_challenge">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.revoke_challenge">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">revoke_challenge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">challenge_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Marks a specific challenge as revoked (Pending -&gt; Revoked) in the rivals table.</span>

<span class="sd">        Unlike accept/decline, this method performs a direct table update on</span>
<span class="sd">        :attr:`~TablesRivals.RIVALS` rather than calling an RPC function. Usually</span>
<span class="sd">        called when some challenge becomes invalid due to internal error, or a</span>
<span class="sd">        challenger wants to revoke their pending challenge with someone.</span>

<span class="sd">        Accesses table : rivals</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        challenge_id : :class:`int`</span>
<span class="sd">            The unique ID of the challenge to revoke.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`bool`</span>
<span class="sd">            ``True`` if the update was successful, ``False`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TablesRivals</span><span class="o">.</span><span class="n">RIVALS</span><span class="p">)</span>
                <span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGE_STATUS</span><span class="p">:</span> <span class="n">ChallengeStatus</span><span class="o">.</span><span class="n">REVOKED</span><span class="p">})</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGE_ID</span><span class="p">,</span> <span class="n">challenge_id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.revoke_challenge()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to revoke challenge, challenge_id : </span><span class="si">{</span><span class="n">challenge_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="DatabaseHandler.store_msg_id">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.store_msg_id">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">store_msg_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">challenge_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Links a Discord message ID to a specific challenge ID in the database.</span>

<span class="sd">        This is used to track the public challenge message so the bot can later</span>
<span class="sd">        update it or delete it if needed.</span>

<span class="sd">        Accesses table : msg_id</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        challenge_id : :class:`int`</span>
<span class="sd">            The unique ID of the challenge.</span>
<span class="sd">        msg_id : :class:`int`</span>
<span class="sd">            The Discord message ID of the notification/embed sent to the channel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">MESG_ID</span><span class="p">)</span>
                <span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="n">MessageIdColumn</span><span class="o">.</span><span class="n">MSG_ID</span><span class="p">:</span> <span class="n">msg_id</span><span class="p">,</span>
                        <span class="n">MessageIdColumn</span><span class="o">.</span><span class="n">CHALLENGE_ID</span><span class="p">:</span> <span class="n">challenge_id</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.store_msg_id()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot store msg_id : </span><span class="si">{</span><span class="n">msg_id</span><span class="si">}</span><span class="s2"> as challenge_id : </span><span class="si">{</span><span class="n">challenge_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="DatabaseHandler.get_current_season">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.get_current_season">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_season</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Retrieves the season number of the currently ongoing season. Used for</span>
<span class="sd">        /season-reset command right now</span>

<span class="sd">        It queries the :attr:`~TableMiscellaneous.SEASONS` table for a row where</span>
<span class="sd">        the status is ``SeasonStatus.ONGOING``.</span>

<span class="sd">        Accesses table : seasons</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`int` | None</span>
<span class="sd">            The current season number if found.</span>
<span class="sd">            Returns ``None`` if no ongoing season exists or if an error occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">SEASONS</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">SeasonColumn</span><span class="o">.</span><span class="n">SEASON</span><span class="p">)</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">SeasonColumn</span><span class="o">.</span><span class="n">STATUS</span><span class="p">,</span> <span class="n">SeasonStatus</span><span class="o">.</span><span class="n">ONGOING</span><span class="p">)</span>
                <span class="o">.</span><span class="n">maybe_single</span><span class="p">()</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">SeasonColumn</span><span class="o">.</span><span class="n">SEASON</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Couldn&#39;t find any ongoing season. Please check the db if it doesn&#39;t sound right.&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.get_current_season()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="s2">&quot;Can&#39;t get stuff for current ongoing season.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="DatabaseHandler.mark_season_archived">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.mark_season_archived">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">mark_season_archived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">season</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Updates the status of a specific season from ONGOING to ARCHIVED.</span>

<span class="sd">        This is typically called at the end of a season (done with /season-reset)</span>
<span class="sd">        to lock it before starting a new one.</span>

<span class="sd">        Accesses table : seasons</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        season : :class:`int`</span>
<span class="sd">            The season number to archive.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`bool`</span>
<span class="sd">            ``True`` if the update was successful (rows were modified).</span>
<span class="sd">            ``False`` if the season was not found, was not ongoing, or an error occurred.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">SEASONS</span><span class="p">)</span>
                <span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">SeasonColumn</span><span class="o">.</span><span class="n">STATUS</span><span class="p">:</span> <span class="n">SeasonStatus</span><span class="o">.</span><span class="n">ARCHIVED</span><span class="p">})</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">SeasonColumn</span><span class="o">.</span><span class="n">SEASON</span><span class="p">,</span> <span class="n">season</span><span class="p">)</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">SeasonColumn</span><span class="o">.</span><span class="n">STATUS</span><span class="p">,</span> <span class="n">SeasonStatus</span><span class="o">.</span><span class="n">ONGOING</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No rows were updated when trying to mark season : </span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2"> as archived.&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.mark_current_archived()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to mark season : </span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">SeasonStatus</span><span class="o">.</span><span class="n">ARCHIVED</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="DatabaseHandler.seasonal_point_update">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.seasonal_point_update">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">seasonal_point_update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FuncStatus</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Synchronizes and awards seasonal points for all leagues. Done during</span>
<span class="sd">        a season&#39;s end</span>

<span class="sd">        Iterates through every league table and performs two RPC calls per league:</span>

<span class="sd">        1. ``sync_table_pp``: Ensures current pp matches the latest osu! API data.</span>
<span class="sd">        2. ``award_seasonal_points``: Calculates and distributes points for the season during it&#39;s end</span>

<span class="sd">        If a league fails to update, the loop continues to the next one, but the</span>
<span class="sd">        function will return an error status at the end.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`FuncStatus`</span>
<span class="sd">            * ``FuncStatus.GOOD``: All leagues updated successfully.</span>
<span class="sd">            * ``FuncStatus.ERROR``: One or more leagues failed to update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error_marker</span> <span class="o">=</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">GOOD</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a_league</span> <span class="ow">in</span> <span class="p">[</span><span class="n">league</span> <span class="k">for</span> <span class="n">league</span> <span class="ow">in</span> <span class="n">TablesLeagues</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">rpc</span><span class="p">(</span>
                        <span class="s2">&quot;sync_table_pp&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;tbl_name&quot;</span><span class="p">:</span> <span class="n">a_league</span><span class="p">}</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                    <span class="n">error_marker</span> <span class="o">=</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">ERROR</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                        <span class="s2">&quot;DatabaseHandler.seasonal_point_update()&quot;</span><span class="p">,</span>
                        <span class="n">error</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;Error syncing </span><span class="si">{</span><span class="n">a_league</span><span class="si">}</span><span class="s2">, seasonal points for these players won&#39;t be updated&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">rpc</span><span class="p">(</span>
                        <span class="s2">&quot;award_seasonal_points&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;league_table_name&quot;</span><span class="p">:</span> <span class="n">a_league</span><span class="p">}</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                    <span class="n">error_marker</span> <span class="o">=</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">ERROR</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                        <span class="s2">&quot;DatabaseHandler.seasonal_point_update()&quot;</span><span class="p">,</span>
                        <span class="n">error</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;Error syncing </span><span class="si">{</span><span class="n">a_league</span><span class="si">}</span><span class="s2">, seasonal points for these players won&#39;t be updated&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">return</span> <span class="n">error_marker</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.seasonal_point_update()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">ERROR</span></div>


<div class="viewcode-block" id="DatabaseHandler.backup_seasonal_points">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.backup_seasonal_points">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">backup_seasonal_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">season_number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FuncStatus</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Backs up the current seasonal points from discord_osu table to column in</span>
<span class="sd">        historical_points table.</span>

<span class="sd">        Calls the RPC ``backup_historical_points``, which copies the current points</span>
<span class="sd">        into a dynamic column named ``season_{number}``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        season_number : :class:`int`</span>
<span class="sd">            The season number to use for the column suffix (e.g., 4 for ``season_4``).</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`FuncStatus`</span>
<span class="sd">            ``FuncStatus.GOOD`` if successful, ``FuncStatus.ERROR`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">column_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;season_</span><span class="si">{</span><span class="n">season_number</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">rpc</span><span class="p">(</span>
                <span class="s2">&quot;backup_historical_points&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;column_name&quot;</span><span class="p">:</span> <span class="n">column_name</span><span class="p">}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">GOOD</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.backup_seasonal_points()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">ERROR</span></div>


<div class="viewcode-block" id="DatabaseHandler.reset_seasonal_points">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.reset_seasonal_points">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">reset_seasonal_points</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FuncStatus</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Resets the seasonal points for all users to zero. (Usually called at the</span>
<span class="sd">        end of the season)</span>

<span class="sd">        Calls the RPC ``reset_seasonal_points``. This is typically done immediately</span>
<span class="sd">        after backing up the points for the previous season.</span>

<span class="sd">        Accesses table : discord_osu</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`FuncStatus`</span>
<span class="sd">            ``FuncStatus.GOOD`` if successful, ``FuncStatus.ERROR`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">rpc</span><span class="p">(</span><span class="s2">&quot;reset_seasonal_points&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">GOOD</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.reset_seasonal_points()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">ERROR</span></div>


<div class="viewcode-block" id="DatabaseHandler.duplicate_table">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.duplicate_table">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">duplicate_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">league</span><span class="p">,</span> <span class="n">season</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FuncStatus</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Creates an archival copy of a league table for a specific season.</span>

<span class="sd">        Calls the RPC ``duplicate_table`` to copy the data from the active league</span>
<span class="sd">        table (e.g., &quot;gold&quot;) to a new archival table (e.g., &quot;gold_4&quot;).</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        league : :class:`str`</span>
<span class="sd">            The name of the league to backup (e.g., &quot;gold&quot;).</span>
<span class="sd">        season : :class:`int`</span>
<span class="sd">            The season number to append to the new table name.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`FuncStatus`</span>
<span class="sd">            ``FuncStatus.GOOD`` if successful, ``FuncStatus.ERROR`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_table</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">league</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">rpc</span><span class="p">(</span>
                <span class="s2">&quot;duplicate_table&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;source_table&quot;</span><span class="p">:</span> <span class="n">league</span><span class="p">,</span> <span class="s2">&quot;new_table_name&quot;</span><span class="p">:</span> <span class="n">new_table</span><span class="p">}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">GOOD</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.duplicate_table()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">ERROR</span></div>


<div class="viewcode-block" id="DatabaseHandler.update_init_pp">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.update_init_pp">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_init_pp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">league</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FuncStatus</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Updates the &#39;initial_pp&#39; value for all users in for the given league</span>
<span class="sd">        to the value in their corrsponding `current_pp` column in discord_osu</span>
<span class="sd">        table. This is done thru RPC function.</span>


<span class="sd">        Calls the RPC ``update_init_pp``. This sets the user&#39;s current PP as their</span>
<span class="sd">        starting PP for the new season or period.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        league : :class:`str`</span>
<span class="sd">            The name of the league table to update.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`FuncStatus`</span>
<span class="sd">            ``FuncStatus.GOOD`` if successful, ``FuncStatus.ERROR`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">rpc</span><span class="p">(</span>
                <span class="s2">&quot;update_init_pp&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;tbl_name&quot;</span><span class="p">:</span> <span class="n">league</span><span class="p">}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">GOOD</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.update_init_pp()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">ERROR</span></div>


<div class="viewcode-block" id="DatabaseHandler.update_leagues">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.update_leagues">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_leagues</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Identifies and processes users who need to be transferred between leagues.</span>

<span class="sd">        This process involves:</span>
<span class="sd">        1. Fetching mismatched rows (users whose PP no longer fits their current league).</span>
<span class="sd">        2. Processing each transfer individually via :meth:`_process_single_transfer`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`list`[:class:`dict`[:class:`str`, :class:`Any`]] | None</span>
<span class="sd">            A list of player dictionaries representing successful transfers.</span>
<span class="sd">            Returns ``None`` if fetching mismatched rows failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">datas</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_mismatched_rows</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">datas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">players</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_single_transfer</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">players</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">players</span></div>


<div class="viewcode-block" id="DatabaseHandler.check_pending">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.check_pending">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_pending</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">challenger_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">challenged_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Checks if a pending challenge exists between two users. Used when someone Accepts</span>
<span class="sd">        a challenge. This function is called to verify that such challenge exists.</span>

<span class="sd">        This queries the :attr:`~TablesRivals.RIVALS` table for any row connecting</span>
<span class="sd">        these two users where the status is ``ChallengeStatus.PENDING``.</span>

<span class="sd">        Accesses table : rivals</span>

<span class="sd">        Internal calls: :meth:`get_username`</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        challenger_id : :class:`int`</span>
<span class="sd">            The Discord ID of the potential challenger.</span>
<span class="sd">        challenged_id : :class:`int`</span>
<span class="sd">            The Discord ID of the potential challenge recipient.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`int` | None</span>
<span class="sd">            The ``challenge_id`` if a pending challenge exists.</span>
<span class="sd">            Returns ``None`` if no pending challenge is found or an error occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">challenger_uname</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_username</span><span class="p">(</span><span class="n">challenger_id</span><span class="p">)</span>
        <span class="n">challenged_uname</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_username</span><span class="p">(</span><span class="n">challenged_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">challenger_uname</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">challenged_uname</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TablesRivals</span><span class="o">.</span><span class="n">RIVALS</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGE_ID</span><span class="p">)</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGER</span><span class="p">,</span> <span class="n">challenger_uname</span><span class="p">)</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGED</span><span class="p">,</span> <span class="n">challenged_uname</span><span class="p">)</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGE_STATUS</span><span class="p">,</span> <span class="n">ChallengeStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">)</span>
                <span class="o">.</span><span class="n">maybe_single</span><span class="p">()</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGE_ID</span><span class="p">]</span>

            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.check_pending()&quot;</span><span class="p">,</span> <span class="n">error</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="DatabaseHandler.check_player_existence_for_points">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.check_player_existence_for_points">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_player_existence_for_points</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        This function&#39;s is used when /point command is called and is used to</span>
<span class="sd">        verify if the given player exist in the database and report back their</span>
<span class="sd">        points if they do.</span>

<span class="sd">        Queries the main discord_osu table for the user&#39;s total and seasonal points.</span>

<span class="sd">        Accesses table : discord_osu</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        discord_id : :class:`int`</span>
<span class="sd">            The Discord ID of the user to check.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`dict`[:class:`str`, :class:`Any`] | :class:`FuncStatus`</span>
<span class="sd">            A dictionary containing ``{&#39;points&#39;: ..., &#39;seasonal_points&#39;: ...}`` if found.</span>
<span class="sd">            Returns ``FuncStatus.EMPTY`` if the user does not exist.</span>
<span class="sd">            Returns ``FuncStatus.ERROR`` if the database query fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Refactor this funtion to make it do just one thing instead of two</span>
        <span class="c1"># stuffs half-ass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">DISCORD_OSU</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">POINTS</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">SEASONAL_POINTS</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">maybe_single</span><span class="p">()</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
            <span class="k">return</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">EMPTY</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.check_player_existence_for_points()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to retrive player &lt;@</span><span class="si">{</span><span class="n">discord_id</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">ERROR</span></div>


<div class="viewcode-block" id="DatabaseHandler.remove_player">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.remove_player">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">remove_player</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Permanently deletes a player from the database.</span>

<span class="sd">        This removes the user&#39;s row from :attr:`~TableMiscellaneous.DISCORD_OSU`.</span>

<span class="sd">        Cascading deletion is enabled so once this function is called, the user&#39;s</span>
<span class="sd">        data is deleted from all table but rivals (and all their ongoing/ pending</span>
<span class="sd">        challenges form rivals tables are delete too, but that&#39;s done in a different</span>
<span class="sd">        function)</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        discord_id : :class:`int`</span>
<span class="sd">            The Discord ID of the user to remove.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`bool`</span>
<span class="sd">            ``True`` if the user was successfully deleted.</span>
<span class="sd">            ``False`` if the user was not found or an error occurred.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">DISCORD_OSU</span><span class="p">)</span>
                <span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="c1"># data was not deleted, so no response in response.data</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to find &lt;@</span><span class="si">{</span><span class="n">discord_id</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.remove_player()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Error occured for &lt;@</span><span class="si">{</span><span class="n">discord_id</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="DatabaseHandler.get_player">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.get_player">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_player</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">FuncStatus</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Retrieves a user&#39;s osu_username, initial_pp and their current_league</span>
<span class="sd">        based on their discord_id. This is to display them on /dashboard in the</span>
<span class="sd">        web.</span>

<span class="sd">        This is a two-step process:</span>

<span class="sd">        1. Fetches basic info (username, pp(this one&#39;s useless, wanna remove it but</span>
<span class="sd">        don&#39;t wanna break anything just in case), league) from the discord_osu table.</span>
<span class="sd">        2. Calls :meth:`_get_player_from_league` to fetch rank and stats from the</span>
<span class="sd">        specific league table (e.g., &quot;gold&quot; or &quot;silver&quot;).</span>

<span class="sd">        Accesses tables : discord_osu , f&quot;{TableLeague.(any)}&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        discord_id : :class:`int`</span>
<span class="sd">            The Discord ID of the user to retrieve.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`dict`[:class:`str`, :class:`Any`] | None | :class:`FuncStatus`</span>
<span class="sd">            A dictionary containing the full player profile if successful.</span>
<span class="sd">            Returns ``None`` if the player is not found in the main table.</span>
<span class="sd">            Returns ``FuncStatus.ERROR`` if an internal error occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query_selector</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">OSU_USERNAME</span><span class="p">,</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">CURRENT_PP</span><span class="p">,</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">LEAGUE</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">DISCORD_OSU</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_selector</span><span class="p">))</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">maybe_single</span><span class="p">()</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_player_from_league</span><span class="p">(</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">LEAGUE</span><span class="p">],</span>
                    <span class="n">discord_id</span><span class="p">,</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">OSU_USERNAME</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.get_player()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Error checking player &lt;@</span><span class="si">{</span><span class="n">discord_id</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">ERROR</span></div>


<div class="viewcode-block" id="DatabaseHandler.check_if_player_exists">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.check_if_player_exists">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_if_player_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Checks if a user is registered in the system.</span>

<span class="sd">        This performs a lightweight &quot;head&quot; query (fetching only the count, not the data)</span>
<span class="sd">        to the :attr:`~TableMiscellaneous.DISCORD_OSU` table to verify their existence.</span>

<span class="sd">        Accesses table : discord_osu</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        discord_id : :class:`int`</span>
<span class="sd">            The unique Discord ID to check.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`bool`</span>
<span class="sd">            ``True`` if the user exists in the database, ``False`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">DISCORD_OSU</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.check_if_player_exists()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Error checking for &lt;@</span><span class="si">{</span><span class="n">discord_id</span><span class="si">}</span><span class="s2">&gt;.&quot;</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="DatabaseHandler.get_active_challenges">
<a class="viewcode-back" href="../../db_handler.html#utils_v2.db_handler.DatabaseHandler.get_active_challenges">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_active_challenges</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">osu_username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="n">FuncStatus</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;|coro|</span>
<span class="sd">        Retrieves all active challenges (Pending or Unfinished) for a specific user.</span>
<span class="sd">        (This function is currently NOT in use anywhere, just here in case I make</span>
<span class="sd">        a functionality to have individual player&#39;s profiles)</span>

<span class="sd">        This checks both the &quot;challenger&quot; and &quot;challenged&quot; columns to find any</span>
<span class="sd">        involvement the user has in ongoing matches.</span>

<span class="sd">        Accessses tables : f&quot;{TableRivals.(any)}&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        discord_id : :class:`int`</span>
<span class="sd">            The Discord ID of the user (used primarily for error logging).</span>
<span class="sd">        osu_username : :class:`str`</span>
<span class="sd">            The user&#39;s osu! username (used for the database query).</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        :class:`list`[:class:`dict`[:class:`str`, :class:`Any`]] | :class:`FuncStatus`</span>
<span class="sd">            A list of dictionary objects representing the active challenges.</span>
<span class="sd">            Returns an empty list ``[]`` if no active challenges are found.</span>
<span class="sd">            Returns ``FuncStatus.ERROR`` if the query fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># note: postgres syntax require double quotes around strings with spaces and these one can have spaces</span>
        <span class="n">osu_username</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">osu_username</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TablesRivals</span><span class="o">.</span><span class="n">RIVALS</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGE_ID</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGED</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGER</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">or_</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGED</span><span class="si">}</span><span class="s2">.eq.</span><span class="si">{</span><span class="n">osu_username</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGER</span><span class="si">}</span><span class="s2">.eq.</span><span class="si">{</span><span class="n">osu_username</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">or_</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGE_STATUS</span><span class="si">}</span><span class="s2">.eq.</span><span class="si">{</span><span class="n">ChallengeStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGE_STATUS</span><span class="si">}</span><span class="s2">.eq.</span><span class="si">{</span><span class="n">ChallengeStatus</span><span class="o">.</span><span class="n">UNFINISHED</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">data</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.get_active_challenge()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Error retriving challenge for &lt;@</span><span class="si">{</span><span class="n">discord_id</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">ERROR</span></div>


    <span class="c1"># ------------------------------------------------------------------------------</span>
    <span class="c1"># Internal / Helper Methods</span>
    <span class="c1"># ------------------------------------------------------------------------------</span>
    <span class="c1"># NOTE: Do not use them unless you have to. Error handling is really inconsistent</span>
    <span class="c1"># in this functions. I&#39;ve let some bubble up while others are handled in place.</span>
    <span class="c1"># So if you are gonna use them,</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_id_from_osu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">osu_username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">DISCORD_OSU</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">)</span>
            <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">OSU_USERNAME</span><span class="p">,</span> <span class="n">osu_username</span><span class="p">)</span>
            <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_id_from_discord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discord_username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">DISCORD_OSU</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">)</span>
            <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_USERNAME</span><span class="p">,</span> <span class="n">discord_username</span><span class="p">)</span>
            <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_osu_from_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">DISCORD_OSU</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">OSU_USERNAME</span><span class="p">)</span>
            <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">)</span>
            <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_arrange_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">headers</span><span class="p">,</span> <span class="n">rows</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_league_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
        <span class="n">query_selector</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">LeagueColumn</span><span class="o">.</span><span class="n">OSU_USERNAME</span><span class="p">,</span>
                <span class="n">LeagueColumn</span><span class="o">.</span><span class="n">INITIAL_PP</span><span class="p">,</span>
                <span class="n">LeagueColumn</span><span class="o">.</span><span class="n">CURRENT_PP</span><span class="p">,</span>
                <span class="n">LeagueColumn</span><span class="o">.</span><span class="n">PP_CHANGE</span><span class="p">,</span>
                <span class="n">LeagueColumn</span><span class="o">.</span><span class="n">PERCENTAGE_CHANGE</span><span class="p">,</span>
                <span class="n">LeagueColumn</span><span class="o">.</span><span class="n">II</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">query_selector</span><span class="p">)</span>
                <span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">LeagueColumn</span><span class="o">.</span><span class="n">PP_CHANGE</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arrange_table</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;DatabaseHandler._fetch_league_data(</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">error</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_in_challenge_tble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tble_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">query_eq</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">TablesRivals</span><span class="o">.</span><span class="n">RIVALS</span><span class="p">,</span> <span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGE_STATUS</span><span class="p">])</span>
        <span class="n">query_selector</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">TablesRivals</span><span class="o">.</span><span class="n">RIVALS</span><span class="si">}</span><span class="s2">!inner(*)&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">tble_type</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">query_selector</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">ChallengeUserColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">query_eq</span><span class="p">,</span> <span class="n">ChallengeStatus</span><span class="o">.</span><span class="n">UNFINISHED</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">count</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler._check_in_challenge_tble()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;The error occured for &lt;@</span><span class="si">{</span><span class="n">discord_id</span><span class="si">}</span><span class="s2">&gt; in </span><span class="si">{</span><span class="n">tble_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> table&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_rivals_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_a</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_b</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">query_and1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;and(</span><span class="si">{</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGER</span><span class="si">}</span><span class="s2">.eq.</span><span class="si">{</span><span class="n">user_a</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGED</span><span class="si">}</span><span class="s2">.eq.</span><span class="si">{</span><span class="n">user_b</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">query_and2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;and(</span><span class="si">{</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGER</span><span class="si">}</span><span class="s2">.eq.</span><span class="si">{</span><span class="n">user_b</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGED</span><span class="si">}</span><span class="s2">.eq.</span><span class="si">{</span><span class="n">user_a</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TablesRivals</span><span class="o">.</span><span class="n">RIVALS</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">or_</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">query_and1</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">query_and2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">ISSUED_AT</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="n">response</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_challenge_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">UTC</span><span class="p">)</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">CHALLENGE_STATUS</span><span class="p">)</span>

            <span class="n">raw_time</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">RivalsColumn</span><span class="o">.</span><span class="n">ISSUED_AT</span><span class="p">)</span>
            <span class="n">issued_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">raw_time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;+00:00&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">ChallengeStatus</span><span class="o">.</span><span class="n">UNFINISHED</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ChallengeFailed</span><span class="o">.</span><span class="n">ONGOING</span>

            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">ChallengeStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ChallengeFailed</span><span class="o">.</span><span class="n">PENDING</span>

            <span class="k">if</span> <span class="n">issued_at</span> <span class="o">&gt;</span> <span class="n">cutoff_time</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ChallengeFailed</span><span class="o">.</span><span class="n">TOO_EARLY</span>

        <span class="k">return</span> <span class="n">ChallengeFailed</span><span class="o">.</span><span class="n">GOOD</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_log_to_challenge_tables</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">challenge_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">challenger</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">Member</span><span class="p">,</span>
        <span class="n">challenged</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">Member</span><span class="p">,</span>
        <span class="n">challenger_ouname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">challenged_ouname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">challenger_duname</span> <span class="o">=</span> <span class="n">challenger</span><span class="o">.</span><span class="n">name</span>
        <span class="n">challenged_duname</span> <span class="o">=</span> <span class="n">challenged</span><span class="o">.</span><span class="n">name</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response1</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">rpc</span><span class="p">(</span>
                <span class="s2">&quot;log_to_challenge_table&quot;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;discord_username&quot;</span><span class="p">:</span> <span class="n">challenger_duname</span><span class="p">,</span>
                    <span class="s2">&quot;osu_username&quot;</span><span class="p">:</span> <span class="n">challenger_ouname</span><span class="p">,</span>
                    <span class="s2">&quot;discord_id&quot;</span><span class="p">:</span> <span class="n">challenger</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;challenge_id&quot;</span><span class="p">:</span> <span class="n">challenge_id</span><span class="p">,</span>
                    <span class="s2">&quot;challenge_table&quot;</span><span class="p">:</span> <span class="n">TablesRivals</span><span class="o">.</span><span class="n">CHALLENGER</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">response1</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error logging for challenger &lt;@</span><span class="si">{</span><span class="n">challenger</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">)</span>

            <span class="n">response2</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">rpc</span><span class="p">(</span>
                <span class="s2">&quot;log_to_challenge_table&quot;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;discord_username&quot;</span><span class="p">:</span> <span class="n">challenged_duname</span><span class="p">,</span>
                    <span class="s2">&quot;osu_username&quot;</span><span class="p">:</span> <span class="n">challenged_ouname</span><span class="p">,</span>
                    <span class="s2">&quot;discord_id&quot;</span><span class="p">:</span> <span class="n">challenged</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;challenge_id&quot;</span><span class="p">:</span> <span class="n">challenge_id</span><span class="p">,</span>
                    <span class="s2">&quot;challenge_table&quot;</span><span class="p">:</span> <span class="n">TablesRivals</span><span class="o">.</span><span class="n">CHALLENGED</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">response2</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error logging for challenged &lt;@</span><span class="si">{</span><span class="n">challenged</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler._log_to_challenge_tables()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Error logging challenge details: &lt;@</span><span class="si">{</span><span class="n">challenger</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&gt; vs &lt;@</span><span class="si">{</span><span class="n">challenged</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&gt;.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_mismatched_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">rpc</span><span class="p">(</span>
                <span class="s2">&quot;get_mismatched_rows&quot;</span><span class="p">,</span> <span class="p">{}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler.update_leagues()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="s2">&quot;Error at rpc function get_mismatched_rows()&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_single_transfer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">uname</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_USERNAME</span><span class="p">]</span>
        <span class="n">league</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">LEAGUE</span><span class="p">]</span>
        <span class="n">future_league</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">FUTURE_LEAGUE</span><span class="p">]</span>
        <span class="n">discord_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">]</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Processing transfer: </span><span class="si">{</span><span class="n">uname</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">league</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">future_league</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Processing League Transfer&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_into_new_league</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">future_league</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_discord_osu_ref</span><span class="p">(</span><span class="n">league</span><span class="p">,</span> <span class="n">future_league</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_USERNAME</span><span class="p">:</span> <span class="n">uname</span><span class="p">,</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">FUTURE_LEAGUE</span><span class="p">:</span> <span class="n">future_league</span><span class="p">,</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">LEAGUE</span><span class="p">:</span> <span class="n">league</span><span class="p">,</span>
            <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">:</span> <span class="n">discord_id</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_insert_into_new_league</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">future_league</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">LeagueColumn</span><span class="o">.</span><span class="n">DISCORD_USERNAME</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_USERNAME</span><span class="p">],</span>
            <span class="n">LeagueColumn</span><span class="o">.</span><span class="n">OSU_USERNAME</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">OSU_USERNAME</span><span class="p">],</span>
            <span class="n">LeagueColumn</span><span class="o">.</span><span class="n">INITIAL_PP</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">CURRENT_PP</span><span class="p">],</span>
            <span class="n">LeagueColumn</span><span class="o">.</span><span class="n">CURRENT_PP</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">CURRENT_PP</span><span class="p">],</span>
            <span class="n">LeagueColumn</span><span class="o">.</span><span class="n">GLOBAL_RANK</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">GLOBAL_RANK</span><span class="p">],</span>
            <span class="n">LeagueColumn</span><span class="o">.</span><span class="n">II</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">II</span><span class="p">],</span>
            <span class="n">LeagueColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">future_league</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">([</span><span class="n">payload</span><span class="p">])</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler._insert_into_new_league()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Failed putting &lt;@</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">]</span><span class="si">}</span><span class="s2">&gt; into </span><span class="si">{</span><span class="n">future_league</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_update_discord_osu_ref</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">old_league</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">future_league</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">TableMiscellaneous</span><span class="o">.</span><span class="n">DISCORD_OSU</span><span class="p">)</span>
                <span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">LEAGUE</span><span class="p">:</span> <span class="n">future_league</span><span class="p">})</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler._update_discord_osu_ref()&quot;</span><span class="p">,</span>
                <span class="n">error</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Failed updating &lt;@</span><span class="si">{</span><span class="n">discord_id</span><span class="si">}</span><span class="s2">&gt; from </span><span class="si">{</span><span class="n">old_league</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">future_league</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_player_from_league</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">league_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">osu_username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">FuncStatus</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase_client</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">league_table</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">LeagueColumn</span><span class="o">.</span><span class="n">INITIAL_PP</span><span class="p">)</span>
                <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">LeagueColumn</span><span class="o">.</span><span class="n">DISCORD_ID</span><span class="p">,</span> <span class="n">discord_id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">maybe_single</span><span class="p">()</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="n">LeagueColumn</span><span class="o">.</span><span class="n">OSU_USERNAME</span><span class="p">:</span> <span class="n">osu_username</span><span class="p">,</span>
                    <span class="n">LeagueColumn</span><span class="o">.</span><span class="n">INITIAL_PP</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">LeagueColumn</span><span class="o">.</span><span class="n">INITIAL_PP</span><span class="p">],</span>
                    <span class="n">DiscordOsuColumn</span><span class="o">.</span><span class="n">LEAGUE</span><span class="p">:</span> <span class="n">league_table</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Data Integrity Error: User &lt;@</span><span class="si">{</span><span class="n">discord_id</span><span class="si">}</span><span class="s2">&gt; exists in &#39;discord_osu&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but is missing from league table &#39;</span><span class="si">{</span><span class="n">league_table</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;DatabaseHandler._get_player_from_league()&quot;</span><span class="p">,</span> <span class="n">error</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">FuncStatus</span><span class="o">.</span><span class="n">ERROR</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">OsuArena</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../db_handler.html">Database API</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2026, Rhythmic-Ocean.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 9.1.0</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>